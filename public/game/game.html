<!doctype html>
<html lang="en">
	<head>
		<!-- Required meta tags -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=yes">
		<!-- Bootstrap CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
		<title>Crow Game</title>
	</head>
	<body>
		<div class="container-fluid" style="">
			<div class="col-12 d-flex" >
			</div>
			<div class="row">
				<div id="body" class="mt-3 ml-1 pr-5 row col-lg-9 container-fluid">
					<div class="d-none d-md-block col-md-2 flex-wrap" id="question-image" >
						<img src="res/crowlogo.png" class=" ml-4 rounded " width="95vh" style=" max-width: 95vh">
					</div>
					<div	class="p-1 col-lg-9 col-md-8 rounded " style="overflow: hidden">
						<div id="questionContainer" class="col-lg-12 col-xs-10 rounded" style="overflow: auto; height:13vh; background-color: #E4E4E4">
							<p id="question">	Sed ut perspiciatis unde omnis Sed ut perspiciatis unde omnis Sed ut perspiciatis unde omnis	Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto. </p>
						</div>
					</div>
					<div id="sideButtons" class="p-2 col-lg-1 col-md-1 rounded ">
						<button type="button" style="width:17vh; background-color:  #FFB9B9" class="mb-1 p-1 btn text-white" >end game</button>

					</div>
					<container id="answerContainer" class="inner bd-example p-1 col-xs-auto container-fluid rounded" style=" overflow-y: scroll; height: 65vh">
						<div id="answerSection" class="d-flex text-secondary mb-1 align-content-stretch flex-wrap bd-highlight " style="" >
						</div>
					</container>
					<div class="modal fade" id="answerModal">
						 <div class="modal-dialog modal-lg">
							 <div class="modal-content">
								 <div id="answerUserModal" class="modal-header">
									 <button type="button" class="close" data-dismiss="modal"> </button>
								 </div>
								 <div id="answerModalBody" class="modal-body">
									<div class="form-group">
									</div>
								 </div>
								 <div class="modal-footer">
									 <button type="button" style="background-color: #FFB9B9" class="btn text-white" data-dismiss="modal">close</button>
								 </div>
							 </div>
						 </div>
					 </div>
				</div>
				<div id="tableSection" class="d-none d-lg-block col-sm-12 col-lg-3 rounded" style=" ">
					<div class="mt-3  rounded-top text-truncate text-center ml-4" style="background-color: #E4E4E4">
						<h3>Users</h3>
					</div>
					<div id="userTable" class=" rounded-bottom  pre-scrollable text-truncate text-center ml-4 " style="max-height: 475px ;background-color: #E4E4E4">
					</div>
				</div>
			</div>
		</div>
			<div id="inputSection" class="justify-content-center mb-1 p-1 mr-0 row">
				<button id="joinGame" type="button" style="background-color: #FFB9B9" class="text-white btn btn-lg " data-toggle="modal" data-target="#secondModal">Join Game</button>
	      <div class="modal fade" id="secondModal">
	         <div class="modal-dialog">
	           <div class="modal-content">
	             <div class="modal-header">
	               <h4 class="modal-title">Join Game</h4>
	             </div>
	             <div class="modal-body">
	               <div class="form-group">
	   					 			<input type="text" placeholder="Name" class="form-control" id="usr" autofocus>
	               </div>
	             </div>
	             <div class="modal-footer">
	               <button type="button" class="btn text-white" style="background-color: #FFB9B9" data-dismiss="modal" onclick="pageJoinGame()">Join</button>
	           </div>
	         </div>
	       </div>
			</div>
		</div>
		<div id="tableSection2" class="d-sm-block d-lg-none col-sm-12 rounded" style=" ">
			<div class="mt-3 rounded-top text-truncate text-center mb-3" style="background-color: #E4E4E4">
			<h3>Users</h3>
			</div>
			<div id="userTable2" class=" rounded-bottom  pre-scrollable text-truncate text-center" style="max-height: 475px ;background-color: #E4E4E4">
			</div>
		</div>
		<div class="modal fade" id="firstModal">
			 <div class="modal-dialog">
				 <div class="modal-content">
					 <div class="modal-header">
						 <h4 class="modal-title">Enter the Next Question</h4>
						 <button type="button" class="text-white close" data-dismiss="modal"> </button>
					 </div>
					 <div class="modal-body">
						 <textarea id="newQuestion" class="form-control" rows="3" placeholder="Question" autofocus></textarea>
					 </div>
					 <div class="modal-footer">
						 <button type="button" style="background-color: #FFB9B9" class="btn text-white" data-dismiss="modal" onclick="pageSubmitQuestion()">Submit</button>
					 </div>
				 </div>
			 </div>
		 </div>
		 <div class="modal fade" id="gameSettingsModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
			 <div class="modal-dialog" role="document">
				 <div class="modal-content">
					 <div class="modal-header">
						 <h5 class="modal-title" id="exampleModalLabel">Game Settings</h5>
						 <button type="button" class="close" data-dismiss="modal" aria-label="Close">
							 <span aria-hidden="true">&times;</span>
						 </button>
					 </div>
					 <div class="modal-body">
						 Game modes:
					 <div class="form-check">
					 	<input class="form-check-input" type="radio" name="gameModes" id="ownerRadio" value="option1" checked>
 						<label class="form-check-label" for="ownerRadio">
 							Owner
 						</label>
 					</div>
 					<div class="form-check">
 						<input class="form-check-input" type="radio" name="gameModes" id="randomRadio" value="option2">
 						<label class="form-check-label" for="randomRadio">
 							Random
 						</label>
 					</div>
 					<div class="form-check">
 						<input class="form-check-input" type="radio" name="gameModes" id="sequentialRadio" value="option2">
 						<label class="form-check-label" for="sequentialRadio">
 							Sequential
 						</label>
					 </div>
					 <p></p>
					 <div class="form-check">
					 <input class="form-check-input" type="checkbox" value="" id="enableAI">
						 <label class="form-check-label" for="defaultCheck1">
							 Enable Deep Learning AI Filtering
						 </label>
					 </div>
				 	 </div>
					 <div class="modal-footer">
						 <button type="button" data-dismiss="modal" class="btn text-white" style="background-color: #FFB9B9" onclick="pageCreateGame()">Create Game</button>
					 </div>
				 </div>
			 </div>
		 </div>
		 <button hidden type="button" id="gameSettingsButton" class="btn btn-primary" data-toggle="modal" data-target="#gameSettingsModal"></button>



		<!-- External JavaScript -->
		<!-- jQuery first, then Popper.js, then Bootstrap JS -->
		<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    	<script src="lib/bootstrap-4.0.0/js/bootstrap.bundle.min.js"></script>
		<script src="lib/socket.io.slim.2.1.0.js"></script>
		<script>
				var socket = io();
				var g;

				// joinRoom if room exists, else prompts to create game
				function init(){
					socket.emit('gameExists',getURL(), function(exists){
						console.log(exists);
						if(exists){
							joinRoom();
						}else{
							console.log('creatGame');
							pageCreateGameDialogue();
						}
					});
				}

				/*
				 * Room Functions
				*/
				// joins the socket room for the game
				function joinRoom(){
					console.log('joinRoom');
					socket.emit('joinRoom',getURL(), function(game){
						console.log(game);
						g = game;
						update(game);
					});
				}

				// gets the current visited URL
				function getURL(){
					return window.location.pathname.substring(1);
				}

				// the server's ping of game data
				socket.on('roomPing', function(game){
					console.log('ping!');
					console.log(game.time);
					console.log(g.time);
					if(game.time>=g.time){
						update(game);
					}
				});

				// downloads the game's data
				function downloadGameData(){
					socket.emit('getDataDownload', function(data){
					var fileName = getURL()+(new Date()).toISOString().slice(0,10).replace(/-/g,"") + ".txt";
					saveFile(fileName,data);
					});
				}

				// saves the passed parameter of data as filename
				function saveFile(filename, data) {
					var blob = new Blob([data], {type: 'text/csv'});
					if(window.navigator.msSaveOrOpenBlob) {
						window.navigator.msSaveBlob(blob, filename);
					}
					else{
						var elem = window.document.createElement('a');
						elem.href = window.URL.createObjectURL(blob);
						elem.download = filename;
						document.body.appendChild(elem);
						elem.click();
						document.body.removeChild(elem);
					}
				}
				// updates based on game data
				function update(game){
					if(!game.ongoing){
						// TODO: show end game
					}
					if(game.queston != g.question){
						pageNewQuestion(game.question);
					}

					pageSetUsers(game.players);
					pageSetAnswers(game.answers)

					g = game;
				}

				/*
				 * Player Functions
				*/
				// requests to join a game
				function joinGame(playerName){
					var player = {name: playerName};
					player.name = playerName;
					player.reacts = [];
					socket.emit('joinGame',player);
				}

				// requests to react to player with an action (String) agree/disagree/star
				function react(player, action){
					socket.emit('react',player,action);
				}

				// request to submit user answer
				function submitAnswer(answer){
					socket.emit('submitAnswer', answer);
					console.log(answer);
				}

				/*
				 * Questioner Functions
				*/
				function askQuestion(question){
					console.log('askQuestion');
					console.log(question);
					socket.emit('askQuestion',question);
				}

				socket.on('isQuestioner',function(is){
					if(is){
						pageNewQuestionButton();
					}
				});

				/*
				 * Owner Functions
				*/

				// requests to create a game
				// questionerMode - the mode of how the questioner changes owner/random/sequential
				function createGame(questionerMode, aiEnabled){
					socket.emit('createGame', getURL(), questionerMode, aiEnabled, function(){
						joinRoom();
					});
				}

				// requests to go to the next question
				function nextQuestion(question){
					socket.emit('nextQuestion');
				}

				// requests the server to end the game
				function endGame(){
					socket.emit('endGame');
				}

				/*
				 * Page Functions
				*/
				function pageSetUsers(users){
					pageRemoveAllUsers();
					for(var i=0;i<users.length;i++){
						pageAddUser(users[i].name);
					}
				}

					// pageSetAnswers: adds the answers to an array
				function pageSetAnswers(answers){
					pageRemoveAllAnswers();
					for(var i =0;i<answers.length;i++){
						console.log(answers[i]);
						pageAddAnswer(answers[i].name,answers[i].text);
					}
				}

					// pageJoinGame: registers user and allows them to answer
				function pageJoinGame() {
					pageShowInputBox();
					var user = document.getElementById("usr").value;
					joinGame(user);
				}
					// pageCreateGameDialogue: calls modal for game creator to choose game settings
				function pageCreateGameDialogue() {
	        document.getElementById("gameSettingsButton").click(); // Click on the checkbox
	      }
					//pageCreateGame: page calls to create game
				function pageCreateGame() {
			        var enableAI = document.getElementById("enableAI").checked;
			        alert(enableAI);
			        var gameMode;
			        if(document.getElementById("ownerRadio").checked = true) {
			          gameMode = "owner";
			        }
			        if(document.getElementById("sequentialRadio").checked = true) {
			          gameMode = "sequential";
			        }
			        if(document.getElementById("randomRadio").checked = true) {
			          gameMode = "random";
			        }
			    createGame(gameMode, enableAI);
	      }

					// pageAddUser: adds a user to the game and to user list
				function pageAddUser(name) {
					var userText = document.createElement("p");
					var text = document.createTextNode(name);
					userText.appendChild(text);
					document.getElementById("userTable").appendChild(userText);
					userText.setAttribute("class","m-2 font-weight-light ");
					userText.setAttribute("style","background-color: #E4E4E4");
					var userText2 = document.createElement("p");
	        var text2 = document.createTextNode(name);
	        userText2.appendChild(text2);
	        document.getElementById("userTable2").appendChild(userText2);
	        userText2.setAttribute("class","  m-2 font-weight-light ");
				}

					// pageRemoveUser: takes user out of game and of user list
				function pageRemoveUser(name) {
					document.getElementById(name).remove();
				}

					// pageRemoveAllUsers: clears all users
				function pageRemoveAllUsers(){
        			var userList = document.getElementById("userTable");
        			while (userList.hasChildNodes()) {
        				userList.removeChild(userList.firstChild);
        			}
      			}

					// pageSubmitQuestion: makes the input text into the new question value
						function pageSubmitQuestion(){
							console.log('pageSubmitQuestion');
							askQuestion(document.getElementById("newQuestion").value);
						}

					// pageNewQuestionButton: Gives the option as a button for a modal asking for a new question
				function pageNewQuestionButton(){
					var container = document.getElementById("sideButtons");
					var button = document.createElement("button");
					var node = document.createTextNode("New Question");
					button.setAttribute("type", "button");
					button.setAttribute("style", "width:17vh;font-size : 15px; background-color: #FFB9B9");
					button.setAttribute("class", "p-2 pr-2 mb-1 btn text-white");
					button.setAttribute("data-toggle", "modal");
					button.setAttribute("data-target", "#firstModal");
					container.appendChild(button);
					button.appendChild(node);
				}

					//  pageNewQuestion: changes the question text
				function pageNewQuestion(question) {
					var container = document.getElementById("questionContainer");
	        var text = document.getElementById("question");
	        var para = document.createElement("p");
	        var node = document.createTextNode(question);
	        para.appendChild(node);
	        text.replaceWith(para);
	        para.setAttribute("id", "question");
				}

					// pageShowAnswer: adds a modal to show the entirety of a question
				function pageShowAnswer(name) {
					var x = document.createElement("DIV");
					x.setAttribute("id", "answerEnlarge");
				}

					// pageShowInputBox: removes the joinButton and adds the answer input box
				function pageShowInputBox() {
	        var section = document.getElementById("inputSection");
	        var textBox = document.createElement("textarea");
	        var joinButton = document.getElementById("joinGame");
	        textBox.setAttribute("class", "form-control col-sm-11 col-md-11");
	        textBox.setAttribute("rows", "3");
	        textBox.setAttribute("id","AnswerBox");
	        textBox.setAttribute("placeholder", "Your Answer");
	        section.appendChild(textBox);
	        joinButton.remove(joinButton);
	        $("textarea").keyup(function(e) {
				var code = e.keyCode ? e.keyCode : e.which;
				if (code == 13) {  // Enter keycode
					var answer = document.getElementById("AnswerBox").value;
					document.getElementById("AnswerBox").value = "";
					submitAnswer(answer);
				   }
				});
	      }

					// pageRemoveAllAnswers: Clears all answers
				function pageRemoveAllAnswers() {
        			var section = document.getElementById("answerSection");
        			while (section.hasChildNodes()) {
          				section.removeChild(section.firstChild);
        			}
     			}

					// pageAddAnswer: creates a new div element containing a username and their answer in a scrollable
					var answerId = 0; // id for each answer
				function pageAddAnswer(user, answer) {
		      answerId+=1;
					var container = document.getElementById("answerContainer");
					var section = document.getElementById("answerSection");
					var newUser = document.createElement("h3");
					var newDiv = document.createElement("div");
					var para = document.createElement("p");
					var answerText = document.createTextNode(answer);
					var userText = document.createTextNode(user);
					newDiv.setAttribute("class", " p-2 col m-1 rounded border");
					newDiv.setAttribute("style", "max-height: 280px; background-color: #E4E4E4;min-width:220px; overflow-y:scroll");
					newDiv.setAttribute("data-toggle", "modal");
	      			newDiv.setAttribute("data-target", "#answerModal");
					newDiv.setAttribute("user", user);
	        		newDiv.setAttribute("answer", answer);
					newDiv.setAttribute("id", answerId);
					newDiv.setAttribute("onclick", "pageAnswerPopup("+ answerId + ")");
					para.setAttribute("class", "p-2");
					newUser.appendChild(userText);
					newDiv.appendChild(newUser);
					para.appendChild(answerText);
					newDiv.appendChild(para);
					section.appendChild(newDiv);
					container.appendChild(section);
				}

					// pageAnswerPopup: creates a popup to show the entirety of an answer
				function pageAnswerPopup(id) {
	        var nameHeader = document.getElementById("answerUserModal");
	        var nameSection = document.createElement("h4");
	        var bodySection = document.getElementById("answerModalBody");
					while (nameHeader.hasChildNodes()) {
						nameHeader.removeChild(nameHeader.firstChild);
					}
					while (bodySection.hasChildNodes()) {
	          bodySection.removeChild(bodySection.firstChild);
	        }
	        nameSection.setAttribute("class", "modal-title");
					var user = document.getElementById(id).getAttribute("user");
	        var answer = document.getElementById(id).getAttribute("answer");
	        var nameText = document.createTextNode(user);
	        var answerTextBox = document.createElement("p");
	        var answerText = document.createTextNode(answer);
	        answerTextBox.appendChild(answerText);
	        bodySection.appendChild(answerTextBox);
	        nameHeader.appendChild(nameSection);
	        nameSection.appendChild(nameText);
	      }

				//joinRoom();
				init();
		</script>
	</body>
</html>
